<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Server Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { opacity: 0.9; }
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav button {
            padding: 10px 20px;
            background: white;
            border: 2px solid #2563eb;
            color: #2563eb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav button:hover { background: #2563eb; color: white; }
        .nav button.active { background: #2563eb; color: white; }
        .section { display: none; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section.active { display: block; }
        .section h2 { margin-bottom: 20px; color: #1e40af; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-small { padding: 6px 12px; font-size: 13px; }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .table tr:hover { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-text { background: #dbeafe; color: #1e40af; }
        .badge-image { background: #dcfce7; color: #166534; }
        .badge-expired { background: #fee2e2; color: #991b1b; }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
        }
        .stat-card h3 { font-size: 32px; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; font-size: 14px; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .login-container h2 { margin-bottom: 20px; text-align: center; color: #1e40af; }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>üîê Admin Login</h2>
        <div id="loginError" class="alert alert-error hidden"></div>
        <div class="form-group">
            <label>API Token</label>
            <input type="password" id="apiToken" placeholder="Enter your API token">
        </div>
        <button class="btn" style="width: 100%;" onclick="login()">Login</button>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <div class="container">
            <div class="header">
                <h1>üéØ Ad Server Dashboard</h1>
                <p>Manage your advertisements, campaigns, and analytics</p>
            </div>

            <div class="nav">
                <button class="active" onclick="showSection('overview')">Overview</button>
                <button onclick="showSection('ads')">Ads</button>
                <button onclick="showSection('campaigns')">Campaigns</button>
                <button onclick="showSection('analytics')">Analytics</button>
                <button onclick="logout()" style="margin-left: auto;">Logout</button>
            </div>

            <div id="messageContainer"></div>

            <!-- Overview Section -->
            <div id="overview" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3 id="totalAds">0</h3>
                        <p>Total Ads</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3 id="activeAds">0</h3>
                        <p>Active Ads</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3 id="totalCampaigns">0</h3>
                        <p>Campaigns</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h3 id="totalImpressions">0</h3>
                        <p>Total Views</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showSection('ads'); document.getElementById('adForm').scrollIntoView();">Create New Ad</button>
                    <button class="btn" onclick="showSection('campaigns')">Manage Campaigns</button>
                    <button class="btn" onclick="showSection('analytics')">View Analytics</button>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Embed Code</h3>
                <p style="margin-bottom: 10px; color: #666;">Copy this code to embed ads on your website:</p>
                <textarea readonly style="width: 100%; font-family: monospace; padding: 10px; background: #f9fafb; border: 1px solid #ddd; border-radius: 4px;">&lt;div id="ad-container" data-tags="tech,go" data-api-url="http://localhost:8080"&gt;&lt;/div&gt;
&lt;script src="http://localhost:8080/embed.js"&gt;&lt;/script&gt;</textarea>
            </div>

            <!-- Ads Section -->
            <div id="ads" class="section">
                <h2>Manage Ads</h2>
                
                <form id="adForm" onsubmit="createAd(event)" style="margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">Create New Ad</h3>
                    
                    <div class="form-group">
                        <label>Ad Type*</label>
                        <select id="adType" onchange="toggleAdFields()">
                            <option value="text">Text Ad</option>
                            <option value="image">Image Ad</option>
                        </select>
                    </div>

                    <div class="form-group" id="contentGroup">
                        <label>Content*</label>
                        <textarea id="adContent" placeholder="Enter ad text content"></textarea>
                    </div>

                    <div class="form-group hidden" id="imageGroup">
                        <label>Image</label>
                        <input type="file" id="adImageFile" accept="image/*" onchange="previewImage()">
                        <p style="margin: 10px 0; color: #666;">OR</p>
                        <input type="text" id="adImageURL" placeholder="Enter image URL (e.g., https://cdn.example.com/image.jpg)">
                        <img id="imagePreview" class="image-preview hidden">
                    </div>

                    <div class="form-group">
                        <label>Redirect URL*</label>
                        <input type="url" id="adRedirectURL" placeholder="https://example.com/landing-page" required>
                    </div>

                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="adTags" placeholder="tech, developer, go">
                    </div>

                    <div class="form-group">
                        <label>Campaign</label>
                        <select id="adCampaign">
                            <option value="">No Campaign</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Expires At (optional)</label>
                        <input type="datetime-local" id="adExpiresAt">
                    </div>

                    <button type="submit" class="btn">Create Ad</button>
                    <button type="button" class="btn" style="background: #6b7280; margin-left: 10px;" onclick="resetAdForm()">Clear</button>
                </form>

                <h3>All Ads</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Content/Image</th>
                            <th>Tags</th>
                            <th>Campaign</th>
                            <th>Expires</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adsTableBody">
                        <tr><td colspan="7" style="text-align: center; color: #999;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Campaigns Section -->
            <div id="campaigns" class="section">
                <h2>Manage Campaigns</h2>
                
                <form onsubmit="createCampaign(event)" style="margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">Create New Campaign</h3>
                    <div class="form-group">
                        <label>Campaign Name*</label>
                        <input type="text" id="campaignName" placeholder="e.g., Summer Sale 2025" required>
                    </div>
                    <button type="submit" class="btn">Create Campaign</button>
                </form>

                <h3>All Campaigns</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Created At</th>
                            <th>Ad Count</th>
                        </tr>
                    </thead>
                    <tbody id="campaignsTableBody">
                        <tr><td colspan="4" style="text-align: center; color: #999;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="section">
                <h2>Analytics & Performance</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ad ID</th>
                            <th>Type</th>
                            <th>Content</th>
                            <th>Views</th>
                            <th>Clicks</th>
                            <th>CTR</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsTableBody">
                        <tr><td colspan="6" style="text-align: center; color: #999;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        let authToken = localStorage.getItem('adserver_token') || '';

        // Initialize
        if (authToken) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboard();
        }

        function login() {
            const token = document.getElementById('apiToken').value.trim();
            if (!token) {
                showLoginError('Please enter an API token');
                return;
            }

            // Test token
            fetch(`${API_URL}/api/ads`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => {
                if (res.ok) {
                    authToken = token;
                    localStorage.setItem('adserver_token', token);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadDashboard();
                } else {
                    showLoginError('Invalid API token');
                }
            })
            .catch(() => showLoginError('Connection error. Is the server running?'));
        }

        function logout() {
            authToken = '';
            localStorage.removeItem('adserver_token');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('apiToken').value = '';
        }

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');

            if (section === 'ads') loadAds();
            if (section === 'campaigns') loadCampaigns();
            if (section === 'analytics') loadAnalytics();
            if (section === 'overview') loadOverview();
        }

        function loadDashboard() {
            loadOverview();
            loadAds();
            loadCampaignsForDropdown();
        }

        function loadOverview() {
            apiRequest('/api/ads').then(ads => {
                ads = ads === null ? [] : ads;
                const active = ads.filter(a => !a.expires_at || new Date(a.expires_at) > new Date());
                document.getElementById('totalAds').textContent = ads.length ? ads.length : '0';
                document.getElementById('activeAds').textContent = active.length ? active.length : '0';
            });

            apiRequest('/api/campaigns').then(campaigns => {
                document.getElementById('totalCampaigns').textContent = campaigns.length;
            });

            apiRequest('/api/analytics/stats').then(stats => {
                const total = stats.reduce((sum, s) => sum + s.views, 0);
                document.getElementById('totalImpressions').textContent = total;
            });
        }

        function loadAds() {
            apiRequest('/api/ads').then(ads => {
                ads = ads === null ? [] : ads;
                const tbody = document.getElementById('adsTableBody');
                if (ads.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No ads yet</td></tr>';
                    return;
                }

                tbody.innerHTML = ads.map(ad => {
                    const isExpired = ad.expires_at && new Date(ad.expires_at) < new Date();
                    const preview = ad.type === 'text' 
                        ? (ad.content.substring(0, 40) + (ad.content.length > 40 ? '...' : ''))
                        : `<img src="${ad.image_url}" style="max-width: 60px; max-height: 40px;">`;
                    
                    return `
                        <tr>
                            <td>${ad.id}</td>
                            <td><span class="badge badge-${ad.type}">${ad.type}</span></td>
                            <td>${preview}</td>
                            <td>${(ad.tags || []).join(', ')}</td>
                            <td>${ad.campaign_id || '-'}</td>
                            <td>${isExpired ? '<span class="badge badge-expired">Expired</span>' : (ad.expires_at ? new Date(ad.expires_at).toLocaleDateString() : 'Never')}</td>
                            <td>
                                <button class="btn btn-small btn-danger" onclick="deleteAd(${ad.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        function loadCampaigns() {
            apiRequest('/api/campaigns').then(campaigns => {
                apiRequest('/api/ads').then(ads => {
                    campaigns = campaigns === null ? [] : campaigns;
                    ads = ads === null ? [] : ads;
                    const tbody = document.getElementById('campaignsTableBody');
                    if (campaigns.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No campaigns yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = campaigns.map(c => {
                        const adCount = ads.filter(a => a.campaign_id === c.id).length;
                        return `
                            <tr>
                                <td>${c.id}</td>
                                <td>${c.name}</td>
                                <td>${new Date(c.created_at).toLocaleDateString()}</td>
                                <td>${adCount}</td>
                            </tr>
                        `;
                    }).join('');
                });
            });
        }

        function loadCampaignsForDropdown() {
            apiRequest('/api/campaigns').then(campaigns => {
                const select = document.getElementById('adCampaign');
                select.innerHTML = '<option value="">No Campaign</option>' + 
                    campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            });
        }

        function loadAnalytics() {
            apiRequest('/api/analytics/stats').then(stats => {
                const tbody = document.getElementById('analyticsTableBody');
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No analytics data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = stats.map(s => `
                    <tr>
                        <td>${s.ad_id}</td>
                        <td><span class="badge badge-${s.ad_type}">${s.ad_type}</span></td>
                        <td>${s.ad_content.substring(0, 40)}${s.ad_content.length > 40 ? '...' : ''}</td>
                        <td>${s.views}</td>
                        <td>${s.clicks}</td>
                        <td><strong>${s.ctr}</strong></td>
                    </tr>
                `).join('');
            });
        }

        function toggleAdFields() {
            const ad_type = document.getElementById('adType').value;
            document.getElementById('contentGroup').classList.toggle('hidden', ad_type === 'image');
            document.getElementById('imageGroup').classList.toggle('hidden', ad_type === 'text');
        }

        function previewImage() {
            const file = document.getElementById('adImageFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function createAd(e) {
            e.preventDefault();

            const ad_type = document.getElementById('adType').value;
            let imageURL = document.getElementById('adImageURL').value.trim();

            // Upload image if file selected
            if (ad_type === 'image' && document.getElementById('adImageFile').files.length > 0) {
                const formData = new FormData();
                formData.append('image', document.getElementById('adImageFile').files[0]);

                const uploadRes = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (uploadRes.ok) {
                    const data = await uploadRes.json();
                    imageURL = `${API_URL}${data.url}`;
                } else {
                    showMessage('Failed to upload image', 'error');
                    return;
                }
            }

            const tags = document.getElementById('adTags').value.split(',').map(t => t.trim()).filter(t => t);
            const expiresAt = document.getElementById('adExpiresAt').value;

            const ad = {
                ad_type,
                content: document.getElementById('adContent').value,
                image_url: imageURL,
                redirect_url: document.getElementById('adRedirectURL').value,
                tags,
                campaign_id: parseInt(document.getElementById('adCampaign').value) || 0,
                expires_at: expiresAt ? new Date(expiresAt).toISOString() : null
            };

            apiRequest('/api/ad/add', 'POST', ad).then(() => {
                showMessage('Ad created successfully!', 'success');
                resetAdForm();
                loadAds();
                loadOverview();
            }).catch(() => showMessage('Failed to create ad', 'error'));
        }

        function deleteAd(id) {
            if (!confirm('Are you sure you want to delete this ad?')) return;

            fetch(`${API_URL}/api/ad/delete/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(res => {
                if (res.ok) {
                    showMessage('Ad deleted successfully!', 'success');
                    loadAds();
                    loadOverview();
                } else {
                    showMessage('Failed to delete ad', 'error');
                }
            });
        }

        function createCampaign(e) {
            e.preventDefault();
            const name = document.getElementById('campaignName').value;

            apiRequest('/api/campaign/add', 'POST', { name }).then(() => {
                showMessage('Campaign created successfully!', 'success');
                document.getElementById('campaignName').value = '';
                loadCampaigns();
                loadCampaignsForDropdown();
                loadOverview();
            }).catch(() => showMessage('Failed to create campaign', 'error'));
        }

        function resetAdForm() {
            document.getElementById('adForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            toggleAdFields();
        }

        function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);

            return fetch(`${API_URL}${endpoint}`, options)
                .then(res => {
                    if (!res.ok) throw new Error('Request failed');
                    return res.json();
                });
        }

        function showMessage(msg, type) {
            const container = document.getElementById('messageContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = msg;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>